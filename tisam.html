<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SAM: Software Automatic Mouth</title>
  <style>
    body {
      max-width: 16cm;
      margin: 0 auto;
      font-family: sans-serif;
      box-sizing: content-box;
    }
    h1, h2 { text-align: center; }
    label, input { display: inline-block; }
    label { width: 30% }
    input { width: 60% }
    input[type="button"] { width: 49%; }
    input[type="range"] { transform: rotate(180deg); }
    textarea {
      width: 95%;
      min-height: 60px;
      resize: vertical;
    }
    table { width: 100% }
    tr th { text-align: left }
    a { cursor: pointer; }
    textarea {
      width: 60%;
      min-height: 60px;
      resize: vertical;
    }
    #transliterate {
      width: 49%;
      display: block;
      margin-left: auto;
      margin-top: 0px;
    }
    #loadfile {
      width: 49%;
      display: inline-block;
      margin-right: 2%;
    }
    #file-input {
      display: none;
    }
    .button-container {
      display: flex;
      gap: 2%;
      margin-top: 10px;
    }
    .button-container input[type="button"] {
      width: 49%;
      margin: 0;
    }
  </style>
</head>
<body>
<h1>SAM Software Automatic Mouth</h1>

<!-- Italian Input Form -->
<form>
  <h2>Translitteratore Italiano</h2>
  <p>
    <strong>Uso:</strong> Carica un file .txt oppure inserisci del testo italiano qui sotto e premi "Translittera" per convertirlo in una forma leggibile da SAM. Il testo convertito apparirà automaticamente nel campo "SPEAK"
  </p>
  <div>
    <label for="italianinput">Testo in italiano:</label>
    <textarea id="italianinput">Un saluto a tutti i miei amici italiani!</textarea>
    <input type="file" id="file-input" accept=".txt" style="display: none;">
    <div class="button-container">
      <input type="button" id="loadfile" value="Carica File .txt">
      <input type="button" id="transliterate" value="Translittera">
    </div>
  </div>
</form>
<hr>

<h2>What is SAM?</h2>
<p>
Sam is a very small Text-To-Speech (TTS) program written in Javascript,
that runs on most popular platforms. It is an adaption to Javascript of
the speech software SAM (Software Automatic Mouth) for the Commodore
C64 published in the year 1982 by Don't Ask Software
(now SoftVoice, Inc.). It includes a Text-To-Phoneme converter called
reciter and a Phoneme-To-Speech routine for the final output.
</p>
<p>
Currently compatible with Firefox, Chrome, Safari + iOS.
The conversion was done by hand from the C source code by
<a href="https://github.com/s-macke/SAM">Sebastian Macke</a>,
and the refactored versions by
<a href="https://github.com/vidarh/SAM">Vidar Hokstad</a> and
<a href="https://github.com/8BitPimp/SAM">8BitPimp</a>
</p>
<script src="samjs.min.js"></script>
<script>
  const opts = {debug: 1, pitch: 64, speed: 72, mouth: 128, throat: 128};
  const presets = {
    sam:               {speed: 72, pitch: 64, throat: 128, mouth: 128},
    elf:               {speed: 72, pitch: 64, throat: 110, mouth: 160},
    little_robot:      {speed: 92, pitch: 60, throat: 190, mouth: 190},
    stuffy_guy:        {speed: 82, pitch: 72, throat: 110, mouth: 105},
    little_old_lady:   {speed: 82, pitch: 32, throat: 145, mouth: 145},
    extra_terrestrial: {speed: 100, pitch: 64, throat: 150, mouth: 200},
  };

  // Simplified Italian to pseudo-English transliteration function for SAM
  function transliterateItalian(text) {
    let result = text;

    // ===== FASE 1: PULIZIA TESTO =====
    
    // Remove BOM and control characters
    result = result.replace(/\uFEFF/g, '');
    result = result.replace(/[\u0000-\u001F\u007F-\u009F]/g, '');
    
    // Normalize spaces
    result = result.replace(/[\u00A0\u1680\u2000-\u200B\u202F\u205F\u3000]/g, ' ');
    
    // Replace smart quotes and typographic characters
    result = result.replace(/[""]/g, '"');
    result = result.replace(/['']/g, "'");
    result = result.replace(/[–—―‒]/g, "-");
    result = result.replace(/[…]/g, "...");
    
    // Clean multiple spaces
    result = result.replace(/\s+/g, ' ').trim();
    
    // Convert to lowercase
    result = result.toLowerCase();

    // Remove accents and diacritics
    result = result.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

    // ===== FASE 2: PROTECTED WORDS (eccezioni) =====
    
    const protectedWords = {
      // Pronouns
      'io': 'eeoh', 'tu': 'too', 'lui': 'loowee', 'lei': 'lay',
      'noi': 'noy', 'voi': 'voy', 'loro': 'loro',
      
      // Common verbs
	  'saro': 'sahro', 'faro': 'fahroh', 'sono': 'sohno', 'sei': 'sehih', 
	  'e': 'eh', 'siamo': 'see ahmo', 'siete': 'see ehtteh',
      
      // Common words
      'anche': 'ahnke', 'perche': 'pehrke', 'che': 'ke',
      'ho': 'oh', 'hai': 'ahy', 'ha': 'ah', 'hanno': 'ahnno',
      'puo': 'poowo', 'puoi': 'poo oi', 'possiamo': 'possyahmo',
      'devo': 'dehvo', 'devi': 'dehvee', 'deve': 'dehve',
      'vedo': 'vehdo', 'vedi': 'vehdee', 
      'vado': 'vahdo', 'vai': 'vahy', 'andiamo': 'andyamo', 'andate': 'andatteh',
      
      // Adverbs
      'gia': 'jiah', 'giu': 'jiuw', 'piu': 'peeuw', 'meno': 'mehno',
      'finche': 'feenkeh', 'benche': 'behnkeh', 'sebbene': 'sehbbehneh',
      'poi': 'poee', 'mai': 'maee', 'ora': 'ohrah', 'qua': 'kwah', 'qui': 'kwee', 
      'li': 'lee', 'la': 'lah',
      'fuori': 'fwohree', 'dentro': 'dehntroh',
      'si': 'see', 'no': 'noh',
      
      // Interjections
      'oh': 'ohh', 'eh': 'ehh', 'ah': 'ahh', 'uh': 'uhh', 'mah': 'mah', 'boh': 'boh',
      
      // Special words
      'ciao': 'chao', 'cielo': 'chehloh', 'gioco': 'g oh ko', 'giochi': 'g oh ki', 
      'gioia': 'joyah', 'eccetera': 'eccheh tera',
      'buono': 'bwohnoh', 'buongiorno': 'bwonjorno', 
      'realta': 'reh ah ltah', 'piace' : 'peeahceh', 'dice': 'dee cheh', 'dici': 'dee che',
      'questo': 'kwehs toh', 'quello': 'kwehl loh', 'quando': 'kwahndo', 'quale': 'kwahleh',
      'mio': 'meeoh', 'mia': 'meeah', 'miei': 'mee eh e', 'ahime': 'himeh',
      'gelo': 'jehlow',
      'cibo': 'cheeboh', 'cena': 'chehnah', 'giro': 'jeeroh', 'gente': 'jehnteh',
      'gnocchi': 'nyokkee', 'bagno': 'bahnyoh', 'figlio': 'feelyoh', 'famiglia': 'fahmeelyah'
    };

    // Replace protected words with placeholders
    const protectedReplacements = [];
    Object.keys(protectedWords).forEach((word, index) => {
      const placeholder = `PRTCTD${index}`;
      const regex = new RegExp('\\b' + word + '\\b', 'g');
      if (result.includes(word)) {
        result = result.replace(regex, placeholder);
        protectedReplacements.push({
          placeholder: placeholder,
          replacement: protectedWords[word]
        });
      }
    });

    // ===== FASE 3: REGOLE FONETICHE (ordine lineare) =====

    // 0. Gestione iato "rea" (es. realta → reh a ltah)
    result = result.replace(/\brea/g, 'reh a');
    
    // 1. CH + E/I → K (es. che → ke, chi → ki)
    result = result.replace(/ch([ei])/g, 'k$1');
    
    // 2. SC + E/I → SH (es. scena → shena, sci → shi)
    result = result.replace(/sc([ei])/g, 'sh$1');
    
    // 3. GN → NY (es. gnocchi → nyokki,ognuno → onyoono)
    result = result.replace(/gn/g, 'ny');
    
    // 4. GLI → LY (es. famiglia → famiglya, gli → ly)
    result = result.replace(/gli/g, 'ly');
    
    // 5. G dolce: GE, GI → J (es. gelato → jelato, giro → jiro)
    result = result.replace(/g([ei])/g, 'j$1');
    
    // 6. C dolce: CE, CI → CH (es. cena → chena, ciao → chao)
    result = result.replace(/c([ei])/g, 'ch$1');
    
    // 7. C dura: CA, CO, CU → K (es. casa → kasa, cuore → kuore)
    result = result.replace(/c([aou])/g, 'k$1');
    
    // 8. Z → TS o DZ
    result = result.replace(/zz/g, 'tts');                    // pizza → pittsa
    result = result.replace(/([aeiou])z([aeiou])/g, '$1dz$2'); // zona → dzohna
    result = result.replace(/z/g, 'ts');                       // zio → tsio (fallback)
    
    // 9. S intervocalica → Z sonora (es. casa → kaza) - DISABILITATA perché troppo aggressiva
    // result = result.replace(/([aeiou])s([aeiou])/g, '$1z$2'); // Corretto da $1z$1 a $1z$2, ma ancora problematico
    
    // 10. H → silent (rimossa)
    result = result.replace(/h/g, '');
    
    // 10.5. Rafforza la 't' raddoppiandola (es. malato -> malatto)
    result = result.replace(/t/g, 'tt');
    result = result.replace(/ttt/g, 'tt'); // Normalizza le 'tt' preesistenti
    
    // 11. Double consonants → mantieni raddoppiate (NO triple)
    result = result.replace(/([bcdfglmnpqrstvz])\1/g, '$1$1');
    
    // 12. X → KS
    result = result.replace(/x/g, 'ks');
    
    // 13. Isolated "e" → EH (congiunzione)
    result = result.replace(/\be\b/g, 'eh');

    // ===== FASE 4: VOCALI =====
    
    // Dittonghi (in ordine di specificità)
    result = result.replace(/ai/g, 'ahy');
    result = result.replace(/ei/g, 'ehy');
    result = result.replace(/oi/g, 'oy');
    result = result.replace(/ui/g, 'ooy');
    result = result.replace(/au/g, 'aow');
    result = result.replace(/eu/g, 'heh uh '); // Gestione iato "e-u"
    
    // Vocali singole
    result = result.replace(/a/g, 'ah');
    result = result.replace(/e/g, 'eh');
    result = result.replace(/i/g, 'ee');
    result = result.replace(/o/g, 'oh');
    result = result.replace(/u/g, 'oo');

    // ===== FASE 5: PULIZIA FINALE =====
    
    // Keep only SAM-safe characters
    result = result.replace(/[^a-zA-Z0-9\s.,!?;:\-'"]/g, '');
    result = result.replace(/\s+/g, ' ').trim();

    // ===== FASE 6: RIPRISTINO PROTECTED WORDS =====
    
    protectedReplacements.forEach(item => {
      result = result.replace(new RegExp(item.placeholder, 'g'), item.replacement);
    });

    return result;
  }

  document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('speechinput');
    const italianInput = document.getElementById('italianinput');
    const fileInput = document.getElementById('file-input');
    const controls = {};

    // File loading functionality
    document.getElementById('loadfile').addEventListener('click', function() {
      fileInput.click();
    });

    fileInput.addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file && file.type === 'text/plain') {
        const reader = new FileReader();
        reader.onload = function(e) {
          let content = e.target.result;
          
          // Additional cleaning for file encoding
          content = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
          
          italianInput.value = content;
          
          // Reset file input to allow loading the same file again
          fileInput.value = '';
        };
        reader.onerror = function() {
          alert('Error loading file. Make sure it is a valid .txt file.');
        };
        // Read as UTF-8
        reader.readAsText(file, 'UTF-8');
      } else {
        alert('Please select a valid .txt file.');
      }
    });

    // Transliteration button
    document.getElementById('transliterate').addEventListener('click', function() {
      const italianText = italianInput.value;
      if (italianText.trim() === '') {
        alert('Enter some Italian text or load a file before transliterating.');
        return;
      }
      const transliterated = transliterateItalian(italianText);
      input.value = transliterated;
    });

    const setOpt = (name, value) => {
      opts[name] = value;
      controls[name].value = value;
      document.getElementById(name + '-lbl').innerText =
        name.charAt(0).toUpperCase() + name.substring(1) + ': ' + value;
    };
    ['speed', 'pitch', 'mouth', 'throat'].forEach((name) => {
      const e = document.getElementById(name);
      controls[name] = e;
      e.onchange = function (e) {
        setOpt(e.target.id, e.target.value);
      };
      e.value = opts[name];
    });
    const selectPreset = (name) => {
      const values = presets[name];
      ['speed', 'pitch', 'mouth', 'throat'].forEach((name) => {
        setOpt(name, values[name]);
      });
    };
    selectPreset('sam');
    Object.keys(presets).forEach((preset) => {
      document.getElementById('preset_' + preset)
        .addEventListener('click', () => selectPreset(preset));
    });

    let speech;
    document.getElementById('say').addEventListener('click', function (e) {
      e.preventDefault();
      if (speech) {
        speech.abort();
      }
      try {
        if (typeof SamJs === 'undefined') {
          alert('SAM library not loaded. Please ensure the SAM.js library is properly included.');
          return;
        }
        speech = (new SamJs(opts)).speak(input.value);
        speech.catch(() => {});
      } catch (error) {
        console.error('Error with SAM speech:', error);
        alert('Error: Unable to generate speech. Please check the SAM library.');
      }
    });

    document.getElementById('download').addEventListener('click', function (e) {
      e.preventDefault();
      try {
        if (typeof SamJs === 'undefined') {
          alert('SAM library not loaded. Please ensure the SAM.js library is properly included.');
          return;
        }
        (new SamJs(opts)).download(input.value);
      } catch (error) {
        console.error('Error with SAM download:', error);
        alert('Error: Unable to generate audio file. Please check the SAM library.');
      }
    });
  });
</script>

<hr>
<form>
  <h2>Speak</h2>
  <div>
    <label for="speechinput">Text to speak:</label>
    <textarea id="speechinput" name="textfield">Hello, my name is SAM.</textarea>
  <hr>
    <label id="pitch-lbl" for="pitch">Pitch: 64</label><input type="range" id="pitch" min="0" max="255" value="64">
    <label id="speed-lbl" for="speed">Speed: 72</label><input type="range" id="speed" min="1" max="255" value="72">
    <label id="mouth-lbl" for="mouth">Mouth: 128</label><input type="range" id="mouth" min="0" max="255" value="128">
    <label id="throat-lbl" for="throat">Throat: 128</label><input type="range" id="throat" min="0" max="255" value="128">
    <input type="button" id="say" value="Say">
    <input type="button" id="download" value="Download">
  </div>
  <hr>
  <h2>Presets</h2>
  <table>
    <thead>
      <tr><th>Description</th><th>Speed</th><th>Pitch</th><th>Throat</th><th>Mouth</th></tr>
    </thead>
    <tbody>
      <tr><td><a id="preset_sam">SAM</a></td><td>72</td><td>64</td><td>128</td><td>128</td></tr>
      <tr><td><a id="preset_elf">Elf</a></td><td>72</td><td>64</td><td>110</td><td>160</td></tr>
      <tr><td><a id="preset_little_robot">Little Robot</a></td><td>92</td><td>60</td><td>190</td><td>190</td></tr>
      <tr><td><a id="preset_stuffy_guy">Stuffy Guy</a></td><td>82</td><td>72</td><td>110</td><td>105</td></tr>
      <tr><td><a id="preset_little_old_lady">Little Old Lady</a></td><td>82</td><td>32</td><td>145</td><td>145</td></tr>
      <tr><td><a id="preset_extra_terrestrial">Extra-Terrestrial</a></td><td>100</td><td>64</td><td>150</td><td>200</td></tr>
    </tbody>
  </table>
</form>
<hr>

<a href="https://github.com/discordier/sam">Github Repository with the source code</a>
<a href="https://discordier.github.io/sam/demos.html">List with some demos.</a>

</body>
</html>
