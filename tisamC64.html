<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TISAM - Translitteratore Italiano per SAM</title>
  <style>
    /* ========== CSS Variables ========== */
    :root {
      --c64-blue: #4040E0;
      --c64-light-blue: #A0A0FF;
      --c64-lighter-blue: #B0B0FF;
      --c64-lightest-blue: #C0C0FF;
      --c64-white: #E0E0FF;
      --font-size-base: 12px;
      --font-size-medium: 16px;
      --spacing-small: 5px;
      --spacing-medium: 15px;
      --spacing-large: 20px;
      --spacing-xlarge: 40px;
    }

    /* ========== Font Face ========== */
    @font-face {
      font-family: 'Bescii Mono';
      src: url('./fonts/Bescii-Mono.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
    }

    /* ========== Base Styles ========== */
    * {
      box-sizing: border-box;
    }

    html {
      background-color: var(--c64-blue);
    }

    body {
      width: 1024px;
      margin: var(--spacing-large) auto;
      padding: var(--spacing-xlarge);
      border: 80px solid var(--c64-light-blue);
      font-family: 'Bescii Mono', monospace, sans-serif;
      font-size: var(--font-size-base);
      color: var(--c64-light-blue);
      box-sizing: content-box;
    }

    /* ========== Typography ========== */
    h1, h2 {
      text-align: center;
    }

    a {
      color: var(--c64-lightest-blue);
      text-decoration: none;
    }

    a:hover,
    a:focus {
      color: var(--c64-white);
      outline: none;
    }

    /* ========== Form Elements ========== */
    label {
      display: inline-block;
      width: 30%;
      vertical-align: top;
    }

    input {
      width: 60%;
    }

    textarea {
      width: 100%;
      min-height: 160px;
      padding: 8px;
      background-color: var(--c64-blue);
      color: var(--c64-light-blue);
      border: 4px solid var(--c64-light-blue);
      font-family: 'Bescii Mono', monospace, sans-serif;
      font-size: var(--font-size-medium);
      line-height: 1.5;
      resize: vertical;
      overflow-y: hidden;
      caret-color: transparent;
    }

    textarea:focus {
      border-color: var(--c64-lighter-blue);
      outline: none;
    }


    .textarea-label {
      display: block;
      margin-top: var(--spacing-medium);
      margin-bottom: var(--spacing-small);
      font-weight: bold;
      font-size: var(--font-size-medium);
    }

    .textarea-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    /* ========== Buttons ========== */
    input[type="button"],
    .btn {
      width: 49%;
      padding: 8px;
      background-color: var(--c64-light-blue);
      color: var(--c64-blue);
      border: 2px solid var(--c64-light-blue);
      font-family: 'Bescii Mono', monospace, sans-serif;
      font-size: var(--font-size-base);
      font-weight: bold;
    }

    input[type="button"]:hover,
    .btn:hover,
    input[type="button"]:focus,
    .btn:focus {
      background-color: var(--c64-lighter-blue);
      outline: none;
    }

    .button-container {
      display: flex;
      gap: 2%;
      margin-top: 10px;
    }

    .button-container input[type="button"] {
      flex: 1;
      margin: 0;
    }

    #info-btn {
      display: block;
      width: 200px;
      margin: 30px auto;
      padding: 12px;
      font-size: var(--font-size-medium);
    }

    #file-input {
      display: none;
    }

    /* ========== Custom Sliders ========== */
    .slider-wrapper {
      position: relative;
      left: var(--spacing-large);
      font-size: var(--font-size-medium);
    }

    .slider-container {
      position: relative;
      width: 60%;
      display: inline-block;
      margin-bottom: var(--spacing-medium);
      margin-left: var(--spacing-xlarge);
      user-select: none;
      touch-action: none;
    }

    .slider-track {
      position: relative;
      height: 15px;
      border: 4px solid var(--c64-light-blue);
      background: transparent;
    }

    .slider-fill {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
      background: var(--c64-light-blue);
      pointer-events: none;
    }

    .slider-thumb {
      position: absolute;
      top: 50%;
      width: 25px;
      height: 25px;
      background: var(--c64-light-blue);
      transform: translate(50%, -50%);
      z-index: 1;
    }

    .slider-thumb:hover,
    .slider-thumb:focus {
      background: var(--c64-lightest-blue);
      outline: none;
    }

    .slider-thumb:active {
      cursor: grabbing;
    }

    /* ========== Blinking Cursor ========== */
    .blinking-cursor {
      position: absolute;
      width: 25px;
      height: 25px;
      background-color: var(--c64-light-blue);
      pointer-events: none;
      display: none;
      animation: blink 1s step-end infinite;
    }

    @keyframes blink {
      50% {
        opacity: 0;
      }
    }

    /* ========== Table ========== */
    table {
      width: 100%;
      margin: var(--spacing-large) 0;
      border-collapse: separate;
      border-spacing: var(--spacing-small) 8px;
    }

    thead th {
      text-align: left;
      padding-bottom: 2px;
      font-size: var(--font-size-medium);
    }

    tbody td {
      padding: var(--spacing-small) 0;
      padding-left: var(--spacing-large);
      font-size: var(--font-size-medium);
    }

    .presets-section a {
      color: var(--c64-light-blue);
    }

    .presets-section a:hover,
    .presets-section a:focus {
      color: var(--c64-lightest-blue);
    }

    /* ========== Modal ========== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      z-index: 1000;
    }

    .modal-overlay.active {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      position: relative;
      max-width: 1000px;
      max-height: 80vh;
      padding: 30px;
      background-color: var(--c64-blue);
      color: var(--c64-light-blue);
      border: 4px solid var(--c64-light-blue);
      border-radius: 0;
      font-size: var(--font-size-medium);
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .modal-close {
      position: absolute;
      top: 10px;
      right: 15px;
      padding: 0;
      background: none;
      border: none;
      color: var(--c64-light-blue);
      font-size: 28px;
      font-weight: bold;
      line-height: 1;
    }

    .modal-close:hover {
      color: #FFFFFF;
    }

    /* ========== Spacing Utilities ========== */
    .spacer-small {
      height: 10px;
    }

    .spacer-medium {
      height: var(--spacing-large);
    }
	
	
	/* ========== Text Selection ========== */
	::selection {
	  background-color: var(--c64-light-blue);
	  color: var(--c64-blue);
	}
		
    /* ========== Hide Native Cursor ========== */
	  *, *::before, *::after {
	  cursor: none !important;
	}


    /* ========== Custom Cursor ========== */
    .custom-cursor {
      position: fixed;
      top: 0;
      left: 0;
      pointer-events: none;
      /* transform is now handled by JS */
      display: none;
      z-index: 9999;
    }
  </style>
</head>

<body>
  <!-- ========== Custom Cursors ========== -->
  <span id="cursor-default" class="custom-cursor">&#x2B61;</span>
  <span id="cursor-pointer" class="custom-cursor">&#x2B61;</span>
  <!-- ========== Header ========== -->
  <header>
    <h1>**** TISAM - COMMODORE 64 GUI ****</h1>
  </header>

  <!-- ========== Main Content ========== -->
  <main>
    <!-- Italian Transliterator Section -->
    <section class="transliterator-section">
      <h1>TRANSILITTERATORE ITALIANO PER SAM</h1>
      <div class="spacer-medium"></div>

      <form>
        <label class="textarea-label" for="italianinput">
          Testo in Italiano:
        </label>
        <textarea 
          id="italianinput" 
          aria-label="Italian text input"
          spellcheck="false"
        >Ciao, sono il translitteratore italiano per SAM. Volevo salutare tutti i miei amici italiani.</textarea>

        <input 
          type="file" 
          id="file-input" 
          accept=".txt" 
          aria-label="File upload"
        >

        <div class="spacer-medium"></div>

        <div class="button-container">
          <input type="button" id="loadfile" value="CARICA FILE .TXT">
          <input type="button" id="cleartext" value="PULISCI TESTO">
          <input type="button" id="copytosam" value="COPIA IN SAM">
          <input type="button" id="transliterate" value="TRANSLITTERA">
        </div>
      </form>
    </section>

    <div class="spacer-medium"></div>

    <!-- SAM Speech Section -->
    <section class="speech-section">
      <h2>SPEAK</h2>

      <form>
        <label class="textarea-label" for="speechinput">
          Text to speak:
        </label>
        <textarea 
          id="speechinput" 
          name="textfield" 
          aria-label="Speech text input"
          spellcheck="false"
        >Hello, my name is SAM.</textarea>

        <div class="spacer-medium"></div>

        <!-- Speech Controls -->
        <div class="slider-wrapper">
          <label id="pitch-lbl">Pitch: 64</label>
          <div 
            class="slider-container" 
            id="pitch-slider" 
            data-min="0" 
            data-max="255" 
            data-value="64"
            role="slider"
            aria-label="Pitch control"
            aria-valuemin="0"
            aria-valuemax="255"
            aria-valuenow="64"
          >
            <div class="slider-track">
              <div class="slider-fill"></div>
            </div>
            <div class="slider-thumb" tabindex="0"></div>
          </div>

          <label id="speed-lbl">Speed: 72</label>
          <div 
            class="slider-container" 
            id="speed-slider" 
            data-min="1" 
            data-max="255" 
            data-value="72"
            role="slider"
            aria-label="Speed control"
            aria-valuemin="1"
            aria-valuemax="255"
            aria-valuenow="72"
          >
            <div class="slider-track">
              <div class="slider-fill"></div>
            </div>
            <div class="slider-thumb" tabindex="0"></div>
          </div>

          <label id="mouth-lbl">Mouth: 128</label>
          <div 
            class="slider-container" 
            id="mouth-slider" 
            data-min="0" 
            data-max="255" 
            data-value="128"
            role="slider"
            aria-label="Mouth control"
            aria-valuemin="0"
            aria-valuemax="255"
            aria-valuenow="128"
          >
            <div class="slider-track">
              <div class="slider-fill"></div>
            </div>
            <div class="slider-thumb" tabindex="0"></div>
          </div>

          <label id="throat-lbl">Throat: 128</label>
          <div 
            class="slider-container" 
            id="throat-slider" 
            data-min="0" 
            data-max="255" 
            data-value="128"
            role="slider"
            aria-label="Throat control"
            aria-valuemin="0"
            aria-valuemax="255"
            aria-valuenow="128"
          >
            <div class="slider-track">
              <div class="slider-fill"></div>
            </div>
            <div class="slider-thumb" tabindex="0"></div>
          </div>
        </div>

        <div class="spacer-medium"></div>

        <div class="button-container">
          <input type="button" id="say" value="SAY">
          <input type="button" id="download" value="DOWNLOAD">
        </div>
      </form>
    </section>

    <!-- Presets Section -->
    <section class="presets-section">
      <div class="spacer-medium"></div>
      <h2>PRESETS</h2>

      <table>
        <thead>
          <tr>
            <th>DESCRIPTION</th>
            <th>SPEED</th>
            <th>PITCH</th>
            <th>THROAT</th>
            <th>MOUTH</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><a id="preset_sam" href="#" role="button">SAM</a></td>
            <td>72</td>
            <td>64</td>
            <td>128</td>
            <td>128</td>
          </tr>
          <tr>
            <td><a id="preset_elf" href="#" role="button">Elf</a></td>
            <td>72</td>
            <td>64</td>
            <td>110</td>
            <td>160</td>
          </tr>
          <tr>
            <td><a id="preset_little_robot" href="#" role="button">Little Robot</a></td>
            <td>92</td>
            <td>60</td>
            <td>190</td>
            <td>190</td>
          </tr>
          <tr>
            <td><a id="preset_stuffy_guy" href="#" role="button">Stuffy Guy</a></td>
            <td>82</td>
            <td>72</td>
            <td>110</td>
            <td>105</td>
          </tr>
          <tr>
            <td><a id="preset_little_old_lady" href="#" role="button">Little Old Lady</a></td>
            <td>82</td>
            <td>32</td>
            <td>145</td>
            <td>145</td>
          </tr>
          <tr>
            <td><a id="preset_extra_terrestrial" href="#" role="button">Extra-Terrestrial</a></td>
            <td>100</td>
            <td>64</td>
            <td>150</td>
            <td>200</td>
          </tr>
        </tbody>
      </table>
    </section>

    <!-- Info Button -->
    <button id="info-btn" class="btn">INFO</button>
  </main>

  <!-- ========== Modal ========== -->
  <aside 
    class="modal-overlay" 
    id="modal" 
    role="dialog" 
    aria-labelledby="modal-title"
    aria-hidden="true"
  >
    <div class="modal-content">
      <button 
        class="modal-close" 
        id="modal-close" 
        aria-label="Close modal"
      >&times;</button>

      <h2 id="modal-title">Come usare TISAM</h2>
      <p>
        Inserisci del testo italiano nella apposita area oppure puoi caricare 
        da un file .txt e premi TRANSLITTERA per convertirlo in fonemi leggibili 
        da SAM. Premi SAY per farlo parlare e DOWNLOAD per scaricare in .wav 
        il testo letto da SAM.
      </p>

      <h2>Cosa è TISAM ?</h2>
      <p>
        E' uno script di translitterazione di fonemi italiani. L'obiettivo del 
        progetto è adattare la fonetica italiana al motore originale, che nasce 
        per l'inglese, permettendo così di ottenere una resa vocale più vicina 
        possibile ai suoni della nostra lingua.
      </p>

      <h2>Cosa è SAM ?</h2>
      <p>
        SAM è un programma di sintesi vocale (Text-To-Speech, TTS) molto piccolo, 
        scritto in Javascript, che funziona sulla maggior parte delle piattaforme 
        più diffuse. É un adattamento in Javascript del software di sintesi vocale 
        SAM (Software Automatic Mouth) per il Commodore C64, pubblicato nel 1982 
        da Don't Ask Software (ora SoftVoice, Inc.). Include un convertitore da 
        testo a fonemi chiamato reciter e una routine da fonemi a voce per 
        l'output finale.
      </p>
      <p>
        Attualmente compatibile con Firefox, Chrome, Safari e iOS.
        La conversione è stata eseguita manualmente a partire dal codice sorgente 
        in C da
        <a href="https://github.com/s-macke/SAM" target="_blank" rel="noopener">
          Sebastian Macke
        </a>,
        e le versioni rifattorizzate da
        <a href="https://github.com/vidarh/SAM" target="_blank" rel="noopener">
          Vidar Hokstad
        </a> e
        <a href="https://github.com/8BitPimp/SAM" target="_blank" rel="noopener">
          8BitPimp
        </a>
      </p>
      <p>
        <a href="https://github.com/discordier/sam" target="_blank" rel="noopener">
          Github Repo con il codice sorgente
        </a>
        <a href="https://discordier.github.io/sam/demos.html" target="_blank" rel="noopener">
          Lista con delle demo
        </a>
      </p>
    </div>
  </aside>

  <!-- ========== External Script ========== -->
  <script src="samjs.min.js"></script>

  <!-- ========== Application Script ========== -->
  <script>
    'use strict';

    // ========== Configuration ==========
    const CONFIG = {
      opts: {
        debug: 1,
        pitch: 64,
        speed: 72,
        mouth: 128,
        throat: 128
      },
      presets: {
        sam: { speed: 72, pitch: 64, throat: 128, mouth: 128 },
        elf: { speed: 72, pitch: 64, throat: 110, mouth: 160 },
        little_robot: { speed: 92, pitch: 60, throat: 190, mouth: 190 },
        stuffy_guy: { speed: 82, pitch: 72, throat: 110, mouth: 105 },
        little_old_lady: { speed: 82, pitch: 32, throat: 145, mouth: 145 },
        extra_terrestrial: { speed: 100, pitch: 64, throat: 150, mouth: 200 }
      }
    };

    // ========== Transliteration Module ==========
    const Transliterator = {
      protectedWords: {
        'tu': 'too', 'lui': 'loowee', 'lei': 'lay', 'loro': 'loro',
        'ai': 'hi', 'saro': 'sahro', 'sono': 'sohno', 'sei': 'sehih',
        'siamo': 'see ahmo', 'siete': 'see ehtteh', 'hanno': 'ahnno',
        'puo': 'poowo', 'puoi': 'poo oi', 'possiamo': 'possyahmo',
        'devo': 'dehvo', 'devi': 'dehvee', 'deve': 'dehve',
        'vedo': 'vehdo', 'vedi': 'vehdee', 'vado': 'vahdo', 'vai': 'vahy',
        'andiamo': 'andyamo', 'andate': 'andatteh', 'gia': 'jiah',
        'giu': 'jiuw', 'piu': 'peeuw', 'meno': 'mehno', 'finche': 'feenkeh',
        'benche': 'behnkeh', 'sebbene': 'sehbbehneh', 'poi': 'poee',
        'mai': 'maee', 'gli': 'jlee', 'glie': 'jle eh', 'qua': 'kwah',
        'qui': 'kwee', 'li': 'lee', 'la': 'lah', 'fuori': 'fwohree',
        'dentro': 'dehntroh', 'si': 'see', 'no': 'noh', 'oh': 'ohh',
        'eh': 'ehh', 'ah': 'ahh', 'uh': 'uhh', 'mah': 'mah', 'boh': 'boh',
        'ciao': 'chao', 'gioco': 'g oh ko', 'giochi': 'g oh ki',
        'gnocchi': 'kneeohkih', 'gnocco': 'kneeohkoh',
        'eccetera': 'eccheh tera', 'buono': 'bwohnoh',
        'buongiorno': 'bwonjorno', 'realta': 'reh ah ltah',
        'acciaio': 'ahkchiah yoh', 'dice': 'dee cheh', 'dici': 'dee che',
        'questo': 'kwehs toh', 'quello': 'kwehl loh', 'quando': 'kwahndo',
        'quale': 'kwahleh', 'mio': 'meeoh', 'mia': 'meeah',
        'miei': 'mee eh e', 'ahime': 'himeh',
		'A': 'ah', 'B': 'bee', 'C': 'che', 'D': 'dee','E': 'eh', 'F': 'ef feh', 'G': 'gee',
        'H': 'ah kah', 'I': 'ee', 'K' : 'kappah','L': 'l eh', 'M': 'm eh', 'N': 'n eh', 'O': 'oh', 'P': 'pee',
        'Q' : 'koo', 'R': 'eh reh',  'S': 'eh seh', 'T': 'tee', 'U': 'oo', 'V': 'vee', 
        'X': 'eeks', 'Y': 'eep cilon', 'Z': 'zeh tah'	
      },

      parseWord(word) {
        let result = '';
        let i = 0;

        while (i < word.length) {
          // Three-character patterns
          if (i + 2 < word.length) {
            const s3 = word.substring(i, i + 3);
            
            if (i === 0 && s3 === 'gno') {
              result += 'know';
              i += 3;
              continue;
            }
            if (i === 0 && s3 === 'cie') {
              result += 'chee eh';
              i += 3;
              continue;
            }
            if (s3 === 'gli') {
              result += 'ly';
              i += 3;
              continue;
            }
            if (s3 === 'cch' && 'ei'.includes(word[i + 3] || '')) {
              result += 'k' + word[i + 3];
              i += 4;
              continue;
            }
            if (s3 === 'sch' && 'ei'.includes(word[i + 3] || '')) {
              result += 'sk' + word[i + 3];
              i += 4;
              continue;
            }
          }

          // Two-character patterns
          if (i + 1 < word.length) {
            const s2 = word.substring(i, i + 2);

            if (s2 === 'ai') { result += 'ahy'; i += 2; continue; }
            if (s2 === 'ei') { result += 'ehy'; i += 2; continue; }
            if (s2 === 'oi') { result += 'oy'; i += 2; continue; }
            if (s2 === 'ui') { result += 'ooy'; i += 2; continue; }
            if (s2 === 'au') { result += 'aow'; i += 2; continue; }
            if (s2 === 'eu') { result += 'heh uh '; i += 2; continue; }

            if (s2 === 'ch' && 'ei'.includes(word[i + 2] || '')) {
              result += 'k' + word[i + 2];
              i += 3;
              continue;
            }
            if (s2 === 'sc' && 'ei'.includes(word[i + 2] || '')) {
              result += 'sh' + word[i + 2];
              i += 3;
              continue;
            }
            if (s2 === 'gn') { result += 'ny'; i += 2; continue; }
            if (s2 === 'zz') { result += 'tts'; i += 2; continue; }
            if (s2 === 'qu') { result += 'kw'; i += 2; continue; }

            if (i === 0 && s2 === 'ge') {
              result += 'ghe';
              i += 2;
              continue;
            }

            const isAtEnd = (i + 2 === word.length);
            if (s2 === 'ce' && isAtEnd) { result += 'cheh'; i += 2; continue; }
            if (s2 === 'ci' && isAtEnd) { result += 'chee'; i += 2; continue; }

            if (s2 === 'ci' || s2 === 'ce') {
              result += 'ch' + s2[1];
              i += 2;
              continue;
            }
            if (s2 === 'gi' || s2 === 'ge') {
              result += 'j' + s2[1];
              i += 2;
              continue;
            }
            if (s2 === 'cu') { result += 'qoo'; i += 2; continue; }
            if (s2[0] === 'c' && 'aou'.includes(s2[1])) {
              result += 'k' + s2[1];
              i += 2;
              continue;
            }
          }

          // Single character patterns
          const s1 = word[i];
          const next = word[i + 1] || '';
          const prev = word[i - 1] || '';

          if (s1 === 'z' && 'aeiou'.includes(prev) && 'aeiou'.includes(next)) {
            result += 'dz';
            i += 1;
            continue;
          }
          if (s1 === 'z') { result += 'ts'; i += 1; continue; }
          if (s1 === 'c') { result += 'k'; i += 1; continue; }
          if (s1 === 'h') { i += 1; continue; }
          if (s1 === 't') { result += 'tt'; i += 1; continue; }
          if (s1 === 'x') { result += 'ks'; i += 1; continue; }
          if (s1 === 'a') { result += 'ah'; i += 1; continue; }
          if (s1 === 'e') { result += 'eh'; i += 1; continue; }
          if (s1 === 'i') { result += 'ee'; i += 1; continue; }
          if (s1 === 'o') { result += 'oh'; i += 1; continue; }
          if (s1 === 'u') { result += 'oo'; i += 1; continue; }

          result += s1;
          i += 1;
        }

        return result.replace(/ttt/g, 'tt');
      },

      parse(text) {
        const words = text.split(/(\s+|[.,!?;:])/);
        let finalResult = '';

        for (const part of words) {
          if (!part) continue;

          // Check for protected words using original case first (for uppercase letters)
          if (this.protectedWords[part]) {
            finalResult += this.protectedWords[part];
            continue;
          }

          // If it's punctuation or space, add it and continue
          if (part.match(/\s+|[.,!?;:]/)) {
            finalResult += part;
            continue;
          }

          // Now, work with lowercase for the rest of the logic
          const lowerPart = part.toLowerCase();

          if (this.protectedWords[lowerPart]) {
            finalResult += this.protectedWords[lowerPart];
            continue;
          }

          if (lowerPart === 'e') {
            finalResult += 'eh';
            continue;
          }

          if (lowerPart.startsWith('rea')) {
            finalResult += 'reh a' + this.parseWord(lowerPart.substring(3));
            continue;
          }

          finalResult += this.parseWord(lowerPart);
        }

        return finalResult;
      },

      transliterate(text) {
        let result = text;

        // Normalize unicode and whitespace
        result = result.replace(/\uFEFF/g, '');
        result = result.replace(/[\u0000-\u001F\u007F-\u009F]/g, '');
        result = result.replace(/[\u00A0\u1680\u2000-\u200B\u202F\u205F\u3000]/g, ' ');
        result = result.replace(/[""]/g, '"');
        result = result.replace(/['']/g, "'");
        result = result.replace(/[––——'']/g, "-");
        result = result.replace(/[…]/g, "...");
        result = result.replace(/\s+/g, ' ').trim();
        result = result.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

        // Parse Italian phonetics
        result = this.parse(result);

        // Clean up
        result = result.replace(/[^a-zA-Z0-9\s.,!?;:\-'"]/g, '');
        result = result.replace(/\s+/g, ' ').trim();

        return result;
      }
    };

    // ========== Slider Manager ==========
    const SliderManager = {
      controls: {},

      init(name) {
        const slider = document.getElementById(`${name}-slider`);
        const fill = slider.querySelector('.slider-fill');
        const thumb = slider.querySelector('.slider-thumb');

        let isDragging = false;
        const min = parseFloat(slider.dataset.min);
        const max = parseFloat(slider.dataset.max);
        let value = parseFloat(slider.dataset.value);

        this.controls[name] = {
          getValue: () => value,
          setValue: (v) => {
            value = v;
            this.updateSlider(slider, fill, thumb, value, min, max, name);
          }
        };

        const setValueFromX = (x) => {
          const rect = slider.getBoundingClientRect();
          const pos = Math.max(0, Math.min(rect.width, rect.right - x)) / rect.width;
          value = Math.round(min + (max - min) * pos);
          this.updateSlider(slider, fill, thumb, value, min, max, name);
        };

        // Mouse events
        thumb.addEventListener('mousedown', (e) => {
          e.preventDefault();
          isDragging = true;
        });

        slider.addEventListener('click', (e) => {
          if (e.target !== thumb) {
            setValueFromX(e.clientX);
          }
        });

        // Touch events
        thumb.addEventListener('touchstart', (e) => {
          e.preventDefault();
          isDragging = true;
        });

        slider.addEventListener('touchstart', (e) => {
          if (e.target !== thumb) {
            setValueFromX(e.touches[0].clientX);
          }
        });

        // Move events
        document.addEventListener('mousemove', (e) => {
          if (isDragging) {
            setValueFromX(e.clientX);
          }
        });

        document.addEventListener('touchmove', (e) => {
          if (isDragging) {
            setValueFromX(e.touches[0].clientX);
          }
        });

        // End events
        document.addEventListener('mouseup', () => {
          isDragging = false;
        });

        document.addEventListener('touchend', () => {
          isDragging = false;
        });

        // Keyboard support
        thumb.addEventListener('keydown', (e) => {
          if (e.key === 'ArrowLeft' || e.key === 'ArrowDown') {
            e.preventDefault();
            value = Math.min(max, value + 1);
            this.updateSlider(slider, fill, thumb, value, min, max, name);
          } else if (e.key === 'ArrowRight' || e.key === 'ArrowUp') {
            e.preventDefault();
            value = Math.max(min, value - 1);
            this.updateSlider(slider, fill, thumb, value, min, max, name);
          }
        });

        this.updateSlider(slider, fill, thumb, value, min, max, name);
      },

      updateSlider(slider, fill, thumb, value, min, max, name) {
        const percentage = ((value - min) / (max - min)) * 100;
        thumb.style.right = `${percentage}%`;
        fill.style.width = `${percentage}%`;
        slider.dataset.value = value;
        slider.setAttribute('aria-valuenow', value);
        
        const label = document.getElementById(`${name}-lbl`);
        label.textContent = `${name.charAt(0).toUpperCase() + name.substring(1)}: ${value}`;
        
        CONFIG.opts[name] = value;
      },

      initAll() {
        ['speed', 'pitch', 'mouth', 'throat'].forEach(name => this.init(name));
      }
    };

    // ========== Modal Controller ==========
    const ModalController = {
      modal: null,

      init() {
        this.modal = document.getElementById('modal');
        
        document.getElementById('info-btn').addEventListener('click', () => {
          this.open();
        });

        document.getElementById('modal-close').addEventListener('click', () => {
          this.close();
        });

        this.modal.addEventListener('click', (e) => {
          if (e.target === this.modal) {
            this.close();
          }
        });

        // ESC key support
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.modal.classList.contains('active')) {
            this.close();
          }
        });
      },

      open() {
        this.modal.classList.add('active');
        this.modal.setAttribute('aria-hidden', 'false');
        document.getElementById('modal-close').focus();
      },

      close() {
        this.modal.classList.remove('active');
        this.modal.setAttribute('aria-hidden', 'true');
      }
    };

    // ========== File Handler ==========
    const FileHandler = {
      fileInput: null,
      italianInput: null,

      init() {
        this.fileInput = document.getElementById('file-input');
        this.italianInput = document.getElementById('italianinput');

        document.getElementById('loadfile').addEventListener('click', () => {
          this.fileInput.click();
        });

        this.fileInput.addEventListener('change', (event) => {
          this.loadFile(event.target.files[0]);
        });
      },

      loadFile(file) {
        if (!file || file.type !== 'text/plain') {
          alert('Please select a valid .txt file.');
          return;
        }

        const reader = new FileReader();

        reader.onload = (e) => {
          let content = e.target.result;
          content = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
          this.italianInput.value = content;
          this.fileInput.value = '';
		  
		  // Trigger resize della textarea
		  this.italianInput.style.height = 'auto';
		  this.italianInput.style.height = this.italianInput.scrollHeight + 'px';
		  
		  // Posiziona cursore alla fine e mostra il blinking cursor
		  this.italianInput.focus();
		  this.italianInput.setSelectionRange(content.length, content.length);
		  
		  // Trigger manual update del cursor position
		  this.italianInput.dispatchEvent(new Event('input'));
        };

        reader.onerror = () => {
          alert('Error loading file. Make sure it is a valid .txt file.');
        };

        reader.readAsText(file, 'UTF-8');
      }
    };

    // ========== SAM Speech Engine ==========
    const SamSpeech = {
      speech: null,

      speak() {
        if (this.speech) {
          this.speech.abort();
        }

        const input = document.getElementById('speechinput');
        
        try {
          if (typeof SamJs === 'undefined') {
            alert('SAM library not loaded. Please ensure samjs.min.js is included.');
            return;
          }

          this.speech = (new SamJs(CONFIG.opts)).speak(input.value);
          this.speech.catch(() => {});
        } catch (error) {
          console.error('Error with SAM speech:', error);
          alert('Error: Unable to generate speech. Please check the SAM library.');
        }
      },

      download() {
        const input = document.getElementById('speechinput');
        
        try {
          if (typeof SamJs === 'undefined') {
            alert('SAM library not loaded. Please ensure samjs.min.js is included.');
            return;
          }

          (new SamJs(CONFIG.opts)).download(input.value);
        } catch (error) {
          console.error('Error with SAM download:', error);
          alert('Error: Unable to generate audio file. Please check the SAM library.');
        }
      }
    };

    // ========== Preset Manager ==========
    const PresetManager = {
      selectPreset(name) {
        const values = CONFIG.presets[name];
        ['speed', 'pitch', 'mouth', 'throat'].forEach((param) => {
          SliderManager.controls[param].setValue(values[param]);
        });
      },

      init() {
        Object.keys(CONFIG.presets).forEach((preset) => {
          const element = document.getElementById(`preset_${preset}`);
          element.addEventListener('click', (e) => {
            e.preventDefault();
            this.selectPreset(preset);
          });
        });
      }
    };

    // ========== Cursor Manager ==========
    const CursorManager = {
      init() {
        document.fonts.ready.then(() => {
          document.querySelectorAll("#italianinput, #speechinput").forEach(textarea => {
            this.initTextareaCursor(textarea);
          });
        }).catch(err => console.error('Font loading error:', err));
      },

      initTextareaCursor(textarea) {
        const wrapper = document.createElement('div');
        wrapper.className = 'textarea-wrapper';
        textarea.parentNode.insertBefore(wrapper, textarea);
        wrapper.appendChild(textarea);

        const cursor = document.createElement('span');
        cursor.className = 'blinking-cursor';
        wrapper.appendChild(cursor);

        const mirror = document.createElement('div');
        mirror.style.cssText = 'position:absolute;left:-9999px;top:0;visibility:hidden;box-sizing:content-box;margin:0;padding:0;border:0;';
        document.body.appendChild(mirror);

        const updateCursorPosition = () => {
          if (!textarea.matches(':focus')) return;

          const style = window.getComputedStyle(textarea);
          const propertiesToCopy = [
            'fontFamily', 'fontSize', 'fontWeight', 'fontStyle',
            'letterSpacing', 'lineHeight', 'wordWrap',
            'whiteSpace', 'wordBreak'
          ];

          propertiesToCopy.forEach(prop => {
            mirror.style[prop] = style[prop];
          });

          // Utilizza getBoundingClientRect() per ottenere la larghezza esatta con precisione decimale,
          // risolvendo il problema di "a capo" anomalo causato da arrotondamenti.
          const rect = textarea.getBoundingClientRect();
          const contentWidth = rect.width - parseFloat(style.borderLeftWidth) - parseFloat(style.borderRightWidth) - parseFloat(style.paddingLeft) - parseFloat(style.paddingRight);
          mirror.style.width = `${contentWidth}px`;

          const textUpToCursor = textarea.value.substring(0, textarea.selectionStart);
          mirror.textContent = textUpToCursor.replace(/\n$/, '\n\u00a0');

          const cursorMarker = document.createElement('span');
          mirror.appendChild(cursorMarker);

          const cursorTop = cursorMarker.offsetTop - textarea.scrollTop;
          const cursorLeft = cursorMarker.offsetLeft - textarea.scrollLeft;

          cursor.style.top = `${cursorTop + parseFloat(style.paddingTop)}px`;
          cursor.style.left = `${cursorLeft + parseFloat(style.paddingLeft)}px`;
        };

        textarea.addEventListener("focus", () => {
          document.querySelectorAll(".blinking-cursor").forEach(c => {
            c.style.display = 'none';
          });
          cursor.style.display = 'block';
          requestAnimationFrame(updateCursorPosition);
        });

        textarea.addEventListener("blur", () => {
          cursor.style.display = 'none';
        });

        textarea.addEventListener("input", updateCursorPosition);
        textarea.addEventListener("click", updateCursorPosition);
        textarea.addEventListener("keyup", updateCursorPosition);
        textarea.addEventListener("scroll", updateCursorPosition);
        textarea.addEventListener("keydown", () => {
            requestAnimationFrame(updateCursorPosition);
        });

        const resizeObserver = new ResizeObserver(updateCursorPosition);
        resizeObserver.observe(textarea);
      }
    };

    // ========== Event Handlers ==========
    const EventHandlers = {
      init() {
        const italianInput = document.getElementById('italianinput');
        const speechInput = document.getElementById('speechinput');

        // Clear text button
        document.getElementById('cleartext').addEventListener('click', () => {
          italianInput.value = '';
          italianInput.focus();
        });

        // Copy to SAM button
        document.getElementById('copytosam').addEventListener('click', () => {
          speechInput.value = italianInput.value;
        });

        // Transliteration button
        document.getElementById('transliterate').addEventListener('click', () => {
          const text = italianInput.value;
          
          if (text.trim() === '') {
            alert('Enter some Italian text or load a file before transliterating.');
            return;
          }

          const transliterated = Transliterator.transliterate(text);
          speechInput.value = transliterated;
        });

        // SAM control buttons
        document.getElementById('say').addEventListener('click', (e) => {
          e.preventDefault();
          SamSpeech.speak();
        });

        document.getElementById('download').addEventListener('click', (e) => {
          e.preventDefault();
          SamSpeech.download();
        });
      }
    };

    // ========== Custom Cursor Manager ==========
    const CustomCursor = {
      config: {
        fontSize: '28px',
        color: 'var(--c64-white)',
		colorHover: 'var(--c64-light-blue)',
        rotationDefault: '-45deg', // Rotation for the default cursor
        rotationPointer: '-45deg'   // Rotation for the pointer cursor
      },

      init() {
        const cursorDefault = document.getElementById('cursor-default');
        const cursorPointer = document.getElementById('cursor-pointer');

        // Apply styles from config
        cursorDefault.style.fontSize = this.config.fontSize;
        cursorDefault.style.color = this.config.colorHover;
        cursorDefault.style.transform = `translate(-50%, -50%) rotate(${this.config.rotationDefault})`;

        cursorPointer.style.fontSize = this.config.fontSize;
        cursorPointer.style.color = this.config.color;
        cursorPointer.style.transform = `translate(-50%, -50%) rotate(${this.config.rotationPointer})`;

        const allElements = document.querySelectorAll(
          'body, a, input[type="button"], .slider-thumb, .slider-container, .btn, .modal-close, textarea'
        );
        const pointerElements = document.querySelectorAll(
          'a, input[type="button"], .slider-thumb, .slider-container, .btn, .modal-close'
        );

        allElements.forEach(el => el.style.cursor = 'none');

        let activeCursor = cursorDefault;
        activeCursor.style.display = 'block';

        document.addEventListener('mousemove', (e) => {
          activeCursor.style.left = `${e.clientX}px`;
          activeCursor.style.top = `${e.clientY}px`;
        });

        pointerElements.forEach(el => {
          el.addEventListener('mouseenter', () => {
            cursorDefault.style.display = 'none';
            cursorPointer.style.display = 'block';
            activeCursor = cursorPointer;
          });
          el.addEventListener('mouseleave', () => {
            cursorPointer.style.display = 'none';
            cursorDefault.style.display = 'block';
            activeCursor = cursorDefault;
          });
        });
      }
    };

    // ========== Application Initialization ==========
    document.addEventListener('DOMContentLoaded', () => {
      SliderManager.initAll();
      PresetManager.init();
      PresetManager.selectPreset('sam');
      ModalController.init();
      FileHandler.init();
      EventHandlers.init();
      CursorManager.init();
      TextareaManager.init();
      CustomCursor.init();

      // Focus iniziale sulla textarea italiana con cursore alla fine
      const italianTextarea = document.getElementById('italianinput');
      if (italianTextarea) {
        setTimeout(() => {
          italianTextarea.focus();
          const len = italianTextarea.value.length;
          italianTextarea.setSelectionRange(len, len);
          // La chiamata a updateCursorPosition viene già gestita dall'evento 'focus'
        }, 100);
      }
    });

    // ========== Textarea Manager ==========
    const TextareaManager = {
      init() {
        document.querySelectorAll('textarea').forEach(textarea => {
          textarea.setAttribute('style', 'height:' + (textarea.scrollHeight) + 'px;overflow-y:hidden;');
          textarea.addEventListener('input', this.onInput, false);
        });
      },

      onInput() {
        // Se l'area di testo è vuota, ripristina l'altezza predefinita.
        if (this.value === '') {
          this.style.height = 'auto';
          return;
        }
        // Altrimenti, aumenta l'altezza solo se il contenuto supera la dimensione attuale.
        // Questo impedisce il restringimento automatico e rispetta il ridimensionamento manuale.
        if (this.scrollHeight > this.clientHeight) {
          this.style.height = this.scrollHeight + 'px';
        }
      }
    };
  </script>
</body>
</html>
