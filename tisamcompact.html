<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SAM: Software Automatic Mouth</title>
  <style>
    body {
      max-width: 16cm;
      margin: 0 auto;
      font-family: sans-serif;
      box-sizing: content-box;
      padding-bottom: 60px;
    }
    h1, h2 { text-align: center; }
    label, input { display: inline-block; }
    label { width: 30% }
    input { width: 60% }
    input[type="button"] { width: 49%; }
    input[type="range"] { transform: rotate(180deg); }
    textarea {
      width: 100%;
      min-height: 80px;
      resize: vertical;
      box-sizing: border-box;
    }
    .textarea-label {
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
      margin-top: 15px;
    }
    table { width: 100%; margin: 20px 0; }
    tr th { text-align: left }
    a { cursor: pointer; }
    .button-container {
      display: flex;
      gap: 2%;
      margin-top: 10px;
    }
    .button-container input[type="button"] {
      flex: 1;
      margin: 0;
    }
    #file-input {
      display: none;
    }
    
    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      z-index: 1000;
    }
    .modal-overlay.active {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 28px;
      font-weight: bold;
      color: #666;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      line-height: 1;
    }
    .modal-close:hover {
      color: #000;
    }
    
    /* Info Button */
    #info-btn {
      display: block;
      width: 200px;
      margin: 30px auto;
      padding: 12px;
      background-color: buttonface; 
      color: black;
      border: 1px solid gray;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    #info-btn:hover {
      background-color: #ddd;
	  color: e5e5e5;
    }
  </style>
</head>
<body>
<h1>SAM Software Automatic Mouth</h1>

<!-- Italian Input Form -->
<form>
  <h2>Translitteratore Italiano</h2>
  <p>
    <strong>Uso:</strong> Carica un file .txt oppure inserisci del testo italiano qui sotto e premi "Translittera" per convertirlo in una forma leggibile da SAM. Il testo convertito apparir√† automaticamente nel campo "Speak"
  </p>
  <div>
    <label class="textarea-label" for="italianinput">Testo in Italiano:</label>
    <textarea id="italianinput">Ciao, sono il translitteratore italiano di SAM. Volevo salutare tutti i miei amici italiani.</textarea>
    <input type="file" id="file-input" accept=".txt" style="display: none;">
	<div style="height:20px;"></div>
    <div class="button-container">
      <input type="button" id="loadfile" value="Carica .txt File">
      <input type="button" id="cleartext" value="Pulisci testo">
      <input type="button" id="copytosam" value="Copia in SAM">
      <input type="button" id="transliterate" value="Translittera">
    </div>
  </div>
</form>

<hr>

<form>
  <h2>Speak</h2>
  <div>
    <label class="textarea-label" for="speechinput">Text to speak:</label>
    <textarea id="speechinput" name="textfield">Hello, my name is SAM.</textarea>
  <hr>
    <label id="pitch-lbl" for="pitch">Pitch: 64</label><input type="range" id="pitch" min="0" max="255" value="64">
    <label id="speed-lbl" for="speed">Speed: 72</label><input type="range" id="speed" min="1" max="255" value="72">
    <label id="mouth-lbl" for="mouth">Mouth: 128</label><input type="range" id="mouth" min="0" max="255" value="128">
    <label id="throat-lbl" for="throat">Throat: 128</label><input type="range" id="throat" min="0" max="255" value="128">
   <div style="height:20px;"></div>
    <input type="button" id="say" value="Say">
    <input type="button" id="download" value="Download">
  </div>
</form>

<hr>

<!-- Presets moved here -->
<h2>Presets</h2>
<table>
  <thead>
    <tr><th>Description</th><th>Speed</th><th>Pitch</th><th>Throat</th><th>Mouth</th></tr>
  </thead>
  <tbody>
    <tr><td><a id="preset_sam">SAM</a></td><td>72</td><td>64</td><td>128</td><td>128</td></tr>
    <tr><td><a id="preset_elf">Elf</a></td><td>72</td><td>64</td><td>110</td><td>160</td></tr>
    <tr><td><a id="preset_little_robot">Little Robot</a></td><td>92</td><td>60</td><td>190</td><td>190</td></tr>
    <tr><td><a id="preset_stuffy_guy">Stuffy Guy</a></td><td>82</td><td>72</td><td>110</td><td>105</td></tr>
    <tr><td><a id="preset_little_old_lady">Little Old Lady</a></td><td>82</td><td>32</td><td>145</td><td>145</td></tr>
    <tr><td><a id="preset_extra_terrestrial">Extra-Terrestrial</a></td><td>100</td><td>64</td><td>150</td><td>200</td></tr>
  </tbody>
</table>
<hr>


<!-- Info Button -->
<button id="info-btn">Info</button>

<!-- Modal -->
<div class="modal-overlay" id="modal">
  <div class="modal-content">
    <button class="modal-close" id="modal-close">&times;</button>
    <h2>What is SAM?</h2>
    <p>
    Sam is a very small Text-To-Speech (TTS) program written in Javascript,
    that runs on most popular platforms. It is an adaption to Javascript of
    the speech software SAM (Software Automatic Mouth) for the Commodore
    C64 published in the year 1982 by Don't Ask Software
    (now SoftVoice, Inc.). It includes a Text-To-Phoneme converter called
    reciter and a Phoneme-To-Speech routine for the final output.
    </p>
    <p>
    Currently compatible with Firefox, Chrome, Safari + iOS.
    The conversion was done by hand from the C source code by
    <a href="https://github.com/s-macke/SAM" target="_blank">Sebastian Macke</a>,
    and the refactored versions by
    <a href="https://github.com/vidarh/SAM" target="_blank">Vidar Hokstad</a> and
    <a href="https://github.com/8BitPimp/SAM" target="_blank">8BitPimp</a>
    </p>
    <p>
    <a href="https://github.com/discordier/sam" target="_blank">Github Repository with the source code</a>
    <a href="https://discordier.github.io/sam/demos.html" target="_blank">List with some demos.</a>
    </p>
  </div>
</div>

<script src="samjs.min.js"></script>
<script>
  const opts = {debug: 1, pitch: 64, speed: 72, mouth: 128, throat: 128};
  const presets = {
    sam:               {speed: 72, pitch: 64, throat: 128, mouth: 128},
    elf:               {speed: 72, pitch: 64, throat: 110, mouth: 160},
    little_robot:      {speed: 92, pitch: 60, throat: 190, mouth: 190},
    stuffy_guy:        {speed: 82, pitch: 72, throat: 110, mouth: 105},
    little_old_lady:   {speed: 82, pitch: 32, throat: 145, mouth: 145},
    extra_terrestrial: {speed: 100, pitch: 64, throat: 150, mouth: 200},
  };

  function fullItalianParser(text) {
    const protectedWords = {
      'tu': 'too', 'lui': 'loowee', 'lei': 'lay', 'loro': 'loro', 'ai':'hi','saro': 'sahro', 'sono': 'sohno', 
	  'sei': 'sehih', 'siamo': 'see ahmo', 'siete': 'see ehtteh', 'hanno': 'ahnno', 'puo': 'poowo', 'puoi': 'poo oi',
	  'possiamo': 'possyahmo', 'devo': 'dehvo', 'devi': 'dehvee', 'deve': 'dehve', 'vedo': 'vehdo', 'vedi': 'vehdee',
      'vado': 'vahdo', 'vai': 'vahy', 'andiamo': 'andyamo', 'andate': 'andatteh',
      'gia': 'jiah', 'giu': 'jiuw', 'piu': 'peeuw', 'meno': 'mehno', 'finche': 'feenkeh',
      'benche': 'behnkeh', 'sebbene': 'sehbbehneh', 'poi': 'poee', 'mai': 'maee', 'gli' : 'jlee', 'glie' : 'jle eh',
      'qua': 'kwah', 'qui': 'kwee', 'li': 'lee', 'la': 'lah', 'fuori': 'fwohree', 'dentro': 'dehntroh',
      'si': 'see', 'no': 'noh', 'oh': 'ohh', 'eh': 'ehh', 'ah': 'ahh', 'uh': 'uhh', 'mah': 'mah', 'boh': 'boh',
      'ciao': 'chao', 'gioco': 'g oh ko', 'giochi': 'g oh ki', 'gnocchi': 'kneeohkih','gnocco':'kneeohkoh',
      'eccetera': 'eccheh tera', 'buono': 'bwohnoh', 'buongiorno': 'bwonjorno',
      'realta': 'reh ah ltah', 'acciaio' : 'ahkchiah yoh', 'dice': 'dee cheh', 'dici': 'dee che',
      'questo': 'kwehs toh', 'quello': 'kwehl loh', 'quando': 'kwahndo', 'quale': 'kwahleh',
      'mio': 'meeoh', 'mia': 'meeah', 'miei': 'mee eh e', 'ahime': 'himeh',
    };

    const words = text.split(/(\s+|[.,!?;:])/);
    let finalResult = '';

    for (const part of words) {
      if (!part) continue;
      if (protectedWords[part]) {
        finalResult += protectedWords[part];
        continue;
      }
      if (part.match(/\s+|[.,!?;:]/)) {
        finalResult += part;
        continue;
      }
      
      if (part === 'e') {
        finalResult += 'eh';
        continue;
      }
      if (part.startsWith('rea')) {
        finalResult += 'reh a' + parseWord(part.substring(3));
        continue;
      }

      finalResult += parseWord(part);
    }
    return finalResult;
  }

  function parseWord(word) {
    let result = '';
    let i = 0;
    while (i < word.length) {
      if (i + 2 < word.length) {
        const s3 = word.substring(i, i + 3);
        if (i === 0 && s3 === 'gno') { result += 'know'; i += 3; continue; }
        if (i === 0 && s3 === 'cie') { result += 'chee eh'; i += 3; continue; }
        if (s3 === 'gli') { result += 'ly'; i += 3; continue; }
        if (s3 === 'cch' && 'ei'.includes(word[i+3]||'')) { result += 'k' + word[i+3]; i += 4; continue; }
        if (s3 === 'sch' && 'ei'.includes(word[i+3]||'')) { result += 'sk' + word[i+3]; i += 4; continue; }
      }

      if (i + 1 < word.length) {
        const s2 = word.substring(i, i + 2);
        if (s2 === 'ai') { result += 'ahy'; i += 2; continue; }
        if (s2 === 'ei') { result += 'ehy'; i += 2; continue; }
        if (s2 === 'oi') { result += 'oy'; i += 2; continue; }
        if (s2 === 'ui') { result += 'ooy'; i += 2; continue; }
        if (s2 === 'au') { result += 'aow'; i += 2; continue; }
        if (s2 === 'eu') { result += 'heh uh '; i += 2; continue; }
        if (s2 === 'ch' && 'ei'.includes(word[i+2]||'')) { result += 'k' + word[i+2]; i += 3; continue; }
        if (s2 === 'sc' && 'ei'.includes(word[i+2]||'')) { result += 'sh' + word[i+2]; i += 3; continue; }
        if (s2 === 'gn') { result += 'ny'; i += 2; continue; }
        if (s2 === 'zz') { result += 'tts'; i += 2; continue; }
        if (s2 === 'qu') { result += 'kw'; i += 2; continue; }

        if (i === 0 && s2 === 'ge') { result += 'ghe'; i += 2; continue; }

        const isAtEnd = (i + 2 === word.length);
        if (s2 === 'ce' && isAtEnd) { result += 'cheh'; i += 2; continue; }
        if (s2 === 'ci' && isAtEnd) { result += 'chee'; i += 2; continue; }

        if (s2 === 'ci' || s2 === 'ce') { result += 'ch' + s2[1]; i += 2; continue; }
        if (s2 === 'gi' || s2 === 'ge') { result += 'j' + s2[1]; i += 2; continue; }
        if (s2[0] === 'c' && 'aou'.includes(s2[1])) { result += 'k' + s2[1]; i += 2; continue; }
      }

      const s1 = word[i];
      const next = word[i+1] || '';
      const prev = word[i-1] || '';

      if (s1 === 'z' && 'aeiou'.includes(prev) && 'aeiou'.includes(next)) { result += 'dz'; i += 1; continue; }
      if (s1 === 'z') { result += 'ts'; i += 1; continue; }
      if (s1 === 'c') { result += 'k'; i += 1; continue; }
      if (s1 === 'h') { i += 1; continue; }
      if (s1 === 't') { result += 'tt'; i += 1; continue; }
      if (s1 === 'x') { result += 'ks'; i += 1; continue; }
      if (s1 === 'a') { result += 'ah'; i += 1; continue; }
      if (s1 === 'e') { result += 'eh'; i += 1; continue; }
      if (s1 === 'i') { result += 'ee'; i += 1; continue; }
      if (s1 === 'o') { result += 'oh'; i += 1; continue; }
      if (s1 === 'u') { result += 'oo'; i += 1; continue; }

      result += s1;
      i += 1;
    }
    result = result.replace(/ttt/g, 'tt');
    return result;
  }

  function transliterateItalian(text) {
    let result = text;

    result = result.replace(/\uFEFF/g, '');
    result = result.replace(/[\u0000-\u001F\u007F-\u009F]/g, '');
    result = result.replace(/[\u00A0\u1680\u2000-\u200B\u202F\u205F\u3000]/g, ' ');
    result = result.replace(/[""]/g, '"');
    result = result.replace(/['']/g, "'");
    result = result.replace(/[‚Äî‚Äî‚Äì‚Äî'']/g, "-");
    result = result.replace(/[‚Ä¶]/g, "...");
    result = result.replace(/\s+/g, ' ').trim();
    result = result.toLowerCase();
    result = result.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

    result = fullItalianParser(result);

    result = result.replace(/[^a-zA-Z0-9\s.,!?;:\-'"]/g, '');
    result = result.replace(/\s+/g, ' ').trim();

    return result;
  }

  document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('speechinput');
    const italianInput = document.getElementById('italianinput');
    const fileInput = document.getElementById('file-input');
    const modal = document.getElementById('modal');
    const controls = {};

    // Modal functionality
    document.getElementById('info-btn').addEventListener('click', function() {
      modal.classList.add('active');
    });

    document.getElementById('modal-close').addEventListener('click', function() {
      modal.classList.remove('active');
    });

    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.classList.remove('active');
      }
    });

    // File loading functionality
    document.getElementById('loadfile').addEventListener('click', function() {
      fileInput.click();
    });

    fileInput.addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file && file.type === 'text/plain') {
        const reader = new FileReader();
        reader.onload = function(e) {
          let content = e.target.result;
          content = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
          italianInput.value = content;
          fileInput.value = '';
        };
        reader.onerror = function() {
          alert('Error loading file. Make sure it is a valid .txt file.');
        };
        reader.readAsText(file, 'UTF-8');
      } else {
        alert('Please select a valid .txt file.');
      }
    });

    // Clear text button
    document.getElementById('cleartext').addEventListener('click', function() {
      italianInput.value = '';
    });

    // Copy to SAM button
    document.getElementById('copytosam').addEventListener('click', function() {
      const italianText = italianInput.value;
      input.value = italianText;
    });

    // Transliteration button
    document.getElementById('transliterate').addEventListener('click', function() {
      const italianText = italianInput.value;
      if (italianText.trim() === '') {
        alert('Enter some Italian text or load a file before transliterating.');
        return;
      }
      const transliterated = transliterateItalian(italianText);
      input.value = transliterated;
    });

    const setOpt = (name, value) => {
      opts[name] = value;
      controls[name].value = value;
      document.getElementById(name + '-lbl').innerText =
        name.charAt(0).toUpperCase() + name.substring(1) + ': ' + value;
    };
    ['speed', 'pitch', 'mouth', 'throat'].forEach((name) => {
      const e = document.getElementById(name);
      controls[name] = e;
      e.onchange = function (e) {
        setOpt(e.target.id, e.target.value);
      };
      e.value = opts[name];
    });
    const selectPreset = (name) => {
      const values = presets[name];
      ['speed', 'pitch', 'mouth', 'throat'].forEach((name) => {
        setOpt(name, values[name]);
      });
    };
    selectPreset('sam');
    Object.keys(presets).forEach((preset) => {
      document.getElementById('preset_' + preset)
        .addEventListener('click', () => selectPreset(preset));
    });

    let speech;
    document.getElementById('say').addEventListener('click', function (e) {
      e.preventDefault();
      if (speech) {
        speech.abort();
      }
      try {
        if (typeof SamJs === 'undefined') {
          alert('SAM library not loaded. Please ensure the SAM.js library is properly included.');
          return;
        }
        speech = (new SamJs(opts)).speak(input.value);
        speech.catch(() => {});
      } catch (error) {
        console.error('Error with SAM speech:', error);
        alert('Error: Unable to generate speech. Please check the SAM library.');
      }
    });

    document.getElementById('download').addEventListener('click', function (e) {
      e.preventDefault();
      try {
        if (typeof SamJs === 'undefined') {
          alert('SAM library not loaded. Please ensure the SAM.js library is properly included.');
          return;
        }
        (new SamJs(opts)).download(input.value);
      } catch (error) {
        console.error('Error with SAM download:', error);
        alert('Error: Unable to generate audio file. Please check the SAM library.');
      }
    });
  });
</script>

</body>
</html>